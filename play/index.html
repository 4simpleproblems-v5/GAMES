<!DOCTYPE html>
<html lang="en">
<head>
    <title>4SP - Game Player</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <link rel="icon" type="image/x-icon" href="../img/favicon.ico" id="faviconLink" />

    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind CSS Configuration (Copied from index(5).html) -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'deep-black': '#070707',
                        'card-dark': '#111111',
                        'accent-indigo': '#4f46e5', // Unified accent color
                        'brand-border': '#252525',
                        'strongdog-orange': '#FFA500', 
                    },
                    fontFamily: {
                        sans: ['Geist', 'sans-serif'],
                    },
                    borderRadius: {
                        'md': '0.375rem',
                        'lg': '0.5rem',
                        'xl': '1rem',
                    },
                    aspectRatio: {
                        '3/2': '3 / 2',
                    },
                }
            },
        }
    </script>
    
    <!-- Custom Styles (Including Marquee) -->
    <style>
        /* Base styles */
        body {
            font-family: 'Geist', sans-serif;
            font-weight: 300;
            background-color: #070707; /* deep-black */
            color: #f3f3f3;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        h1, h2, h3, .font-bold, .font-semibold, strong {
            font-weight: 400 !important;
        }

        /* Game Container Aspect Ratio (16:9) */
        .game-container {
            width: 100%;
            padding-top: 56.25%; /* 9 / 16 * 100% for 16:9 aspect ratio */
            background-color: #000;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
        }

        .game-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Styling for the control buttons */
        .control-btn {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            background-color: #1a1a1a; /* Dark background for controls */
            border: 1px solid #252525; /* brand-border */
            font-size: 20px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .control-btn:hover {
            transform: scale(1.05);
            background: #000;
            border-color: #4f46e5; /* accent-indigo */
        }

        /* Favorite Star coloring */
        #favoriteButton.favorited .fa-solid-star {
            color: #facc15; /* yellow-400 */
        }
        
        /* Marquee setup for the game title */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            /* Marquee Fix: Increased max-width allowance for title */
            max-width: calc(100% - 100px); /* Tighter fit to the buttons */
        }
        
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .marquee-text {
            display: inline-block;
            padding-left: 100%; /* Start off-screen */
        }
        
        /* Apply animation only when content overflows (handled by JS) */
        .marquee-container.animate .marquee-text {
            /* Marquee Fix: Reduced time for less perceived gap between loops */
            animation: marquee 7.5s linear infinite; 
        }

        @media (max-width: 640px) {
            /* On small screens, reduce overall padding and increase available game width */
            .main-content {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            .marquee-container {
                max-width: calc(100% - 80px); /* Tighter space for mobile buttons */
            }
            .control-btn {
                width: 38px;
                height: 38px;
                font-size: 18px;
            }
        }
    </style>
</head>

<body class="bg-deep-black text-white min-h-screen">
    <!-- Navbar from index(4).html, updated with Tailwind classes for appearance -->
    <div class="navbar sticky top-0 z-50 bg-black/70 backdrop-blur-lg border-b border-brand-border h-16 flex items-center justify-between px-6 shadow-xl">
        <a href="https://forsimpleproblems.github.io/" class="text-white font-semibold text-lg" style="font-weight: 400;">4SP Games</a>
        <div></div> <!-- Spacer for right alignment consistency -->
    </div>

    <main class="mx-auto my-8 w-full max-w-[96%] xl:max-w-screen-xl px-2 main-content">
        <!-- Game Area -->
        <div class="game-area" id="gameArea">
            
            <!-- NEW: Control Bar Above Frame - Added z-index and relative for clickability fix -->
            <div class="flex justify-between items-center mb-4 p-2 bg-card-dark rounded-xl border border-brand-border z-20 relative">
                
                <!-- Game Title Top Left (Marquee) - Added flex-grow for wider container -->
                <div id="gameTitleContainer" class="marquee-container text-white text-xl font-semibold overflow-hidden flex-grow">
                    <span id="gameTitle" class="marquee-text" style="font-weight: 400;">Loading Game...</span>
                </div>

                <!-- Control Buttons Top Right -->
                <div id="gameOverlayButtons" class="flex items-center space-x-3 flex-shrink-0">
                    <!-- Favorite Button -->
                    <button id="favoriteButton" class="control-btn text-white focus:outline-none" title="Favorite Game">
                        <!-- Font Awesome Icons -->
                        <i class="fa-solid fa-star fa-solid-star text-gray-500 transition-colors hidden"></i>
                        <i class="fa-regular fa-star fa-regular-star text-white transition-colors"></i>
                    </button>
                    <!-- Fullscreen Button -->
                    <button id="fullscreenButton" class="control-btn text-white focus:outline-none" title="Fullscreen">
                        <i class="fa-solid fa-expand"></i>
                    </button>
                </div>
            </div>

            <!-- Game Frame Container - Added z-index for clickability fix -->
            <div class="game-container z-10 relative" id="gameContainer">
                <!-- Iframe will be injected here -->
            </div>
            
            <p id="fullscreenDisclaimer" class="text-center text-gray-400 mt-4 mb-8 text-sm">
                Use the fullscreen button for a better experience.
            </p>
        </div>
    </main>
    
    <!-- External Scripts for Firebase and app logic (kept, paths are relative to index(4).html) -->
    <script src="../firebase-config.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../ban-enforcer.js"></script>
    <script src="../url-changer.js"></script>
    <script src="../navigation.js"></script>
    <script src="../appscript.js"></script>
    
    <!-- Firebase/Auth Scripts from index(4).html -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- Main Game Loading and Logic -->
    <script type="module">
        import games from "../cards-data.js";
        import {
            siteMapping
        } from "../site-mapping.js";

        // --- Utility Functions for Marquee ---
        function updateMarquee(title) {
            const container = document.getElementById('gameTitleContainer');
            const textElement = document.getElementById('gameTitle');
            
            // Set the title text
            textElement.textContent = title;
            textElement.title = title;
            
            // Wait for the DOM to render the text to check its scroll width
            setTimeout(() => {
                // If the text width is greater than the container's max-width, apply marquee class
                if (textElement.scrollWidth > container.clientWidth) {
                    container.classList.add('animate');
                } else {
                    container.classList.remove('animate');
                    textElement.style.paddingLeft = '0'; // Remove padding for non-scrolling text
                }
            }, 50);
        }

        // --- Firebase/Favorites Management ---
        const favoriteButton = document.getElementById("favoriteButton");
        let currentUserId = null;
        let currentGameId = null;

        function toggleFavoriteUI(isFavorited) {
            favoriteButton.classList.toggle('favorited', isFavorited);
            favoriteButton.title = isFavorited ? 'Remove from Favorites' : 'Add to Favorites';
            // Simple Font Awesome toggle based on the 'favorited' class
            favoriteButton.querySelector('.fa-solid-star').classList.toggle('hidden', !isFavorited);
            favoriteButton.querySelector('.fa-regular-star').classList.toggle('hidden', isFavorited);
        }
        
        async function loadFavoriteStatus(userId, gameId) {
            if (!userId || !gameId) return;
            currentUserId = userId;
            currentGameId = gameId;

            // Using the new secure Firestore path structure
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const db = firebase.firestore();
            
            // Private data storage path: /artifacts/{appId}/users/{userId}/favorites
            const favoriteDocRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('favorites').doc(String(gameId));
            
            try {
                const doc = await favoriteDocRef.get();
                const isFavorited = doc.exists;
                toggleFavoriteUI(isFavorited);
            } catch (error) {
                console.error("Error loading favorite status:", error);
            }
        }

        async function toggleFavorite() {
            if (!currentUserId || !currentGameId) return;
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const db = firebase.firestore();
            // Private data storage path: /artifacts/{appId}/users/{userId}/favorites
            const favoriteDocRef = db.collection('artifacts').doc(appId).collection('users').doc(currentUserId).collection('favorites').doc(String(currentGameId));

            try {
                const doc = await favoriteDocRef.get();
                if (doc.exists) {
                    // Remove favorite
                    await favoriteDocRef.delete();
                    toggleFavoriteUI(false);
                    console.log("Favorite removed.");
                } else {
                    // Add favorite
                    await favoriteDocRef.set({ 
                        added: firebase.firestore.FieldValue.serverTimestamp(),
                        gameId: currentGameId,
                        // Optionally store game name for easier lookup
                        gameName: document.getElementById('gameTitle').textContent 
                    });
                    toggleFavoriteUI(true);
                    console.log("Favorite added.");
                }
            } catch (error) {
                console.error("Error toggling favorite:", error);
            }
        }
        
        favoriteButton.addEventListener("click", toggleFavorite);
        // --- END Firebase/Favorites Management ---


        // --- Game Loading Logic (Updated for new structure) ---

        function getCurrentKeyHostOnly() {
            return window.location.host;
        }

        function getBaseURLForPage(page) {
            const currentHost = getCurrentKeyHostOnly();
            const currentPath = window.location.pathname;

            if (currentHost === "forsimpleproblems.github.io" && currentPath.toLowerCase().startsWith('/strongdog/')) {
                if (!page || page === 1) return "/STRONGDOG/";
                if (page === 2) return "/strongdog2/";
                if (page === 3) return "/strongdog3/";
                if (page === 4) return "/strongdog4/";
                if (page === 5) return "/strongdog5/";
                return "/STRONGDOG/";
            }
            const explicitMappings = {
                "jman1593.github.io": {
                    2: "../strongdog2/",
                },
                "v5-4simpleproblems.github.io": {
                    2: "../../strongdog2/",
                    3: "../../strongdog3/",
                    4: "../../strongdog4/",
                    5: "../../strongdog5/",
                }
            };
            if (explicitMappings[currentHost] && explicitMappings[currentHost][page]) {
                return explicitMappings[currentHost][page];
            }
            if (!page || page === 1) return "../";
            const arr = siteMapping[currentHost];
            if (!arr) {
                if (page === 2) return "../../strongdog2/";
                if (page === 3) return "../../strongdog3/";
                if (page === 4) return "../../strongdog4/";
                if (page === 5) return "../../strongdog5/";
                return "../";
            }
            const index = page - 2;
            if (arr[index]) return arr[index].replace(/^\.\/$/, "../");
            if (page === 2) return "../../strongdog2/";
            if (page === 3) return "../../strongdog3/";
            if (page === 4) return "../../strongdog4/";
            if (page === 5) return "../../strongdog5/";
            return "../../";
        }

        async function getEmbedPath(adjustedHref, originalHref, page) {
            let cleanHref = adjustedHref.replace(/index\.html$/, "").replace(/base\.html$/, "").replace(/\.html$/, "");
            if (!cleanHref.endsWith("/")) cleanHref += "/";
            const pathsToTry = [cleanHref + "game/index.html", cleanHref + "game/base.html", cleanHref + "gamereal/index.html", cleanHref + "gamereal/base.html", cleanHref + "index.html", cleanHref + "base.html", ];
            try {
                const response = await fetch(adjustedHref, {
                    method: "GET"
                });
                if (response.ok) {
                    const text = await response.text();
                    const match = text.match(/embedGame\((['"])(.*?)\1,\s*(['"])(.*?)\3\)/);
                    if (match) {
                        const [, , embedPath, , title] = match;
                        const resolvedPath = new URL(embedPath, adjustedHref).href;
                        if (await fileExists(resolvedPath)) return resolvedPath;
                    }
                }
            } catch (error) {
                console.warn("Failed to parse embed path from cards-data.js", error);
            }
            for (const path of pathsToTry) {
                if (await fileExists(path)) return path;
            }
            return adjustHrefPath(originalHref, page);
        }

        function adjustHrefPath(path, page) {
            path = path.replace(/^\.\//, "").replace(/^\//, "");
            const baseURL = getBaseURLForPage(page);
            let finalPath;
            if (baseURL === "../") {
                finalPath = "../" + path;
            } else {
                finalPath = baseURL.endsWith("/") ? baseURL + path : baseURL + "/" + path;
            }
            return finalPath;
        }

        async function fileExists(url) {
            try {
                const response = await fetch(url, {
                    method: "HEAD"
                });
                return response.ok;
            } catch {
                return false;
            }
        }

        function embedGame(gamePath, title) {
            const iframe = document.createElement("iframe");
            iframe.src = gamePath;
            iframe.allowFullscreen = true;
            iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-fullscreen');

            const gameContainer = document.getElementById('gameContainer');
            gameContainer.innerHTML = ''; 
            gameContainer.appendChild(iframe);

            // Update title with marquee logic
            updateMarquee(title);
        }
        
        // --- Fullscreen Logic ---
        const fullscreenButton = document.getElementById("fullscreenButton");
        fullscreenButton.addEventListener("click", () => {
            const gameIframe = document.querySelector('#gameContainer iframe');
            const gameContainer = document.getElementById('gameContainer');
            
            if (gameContainer && gameContainer.requestFullscreen) {
                // Request fullscreen on the container, which holds the iframe
                gameContainer.requestFullscreen();
            } else if (gameIframe) {
                // Fallback to requesting fullscreen on the iframe if the container fails
                if (gameIframe.requestFullscreen) {
                    gameIframe.requestFullscreen();
                } else if (gameIframe.webkitRequestFullscreen) {
                    gameIframe.webkitRequestFullscreen();
                } else if (gameIframe.msRequestFullscreen) {
                    gameIframe.msRequestFullscreen();
                }
            }
        });

        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get("id");
            let selectedGame = null;

            if (gameId) {
                const idNum = parseInt(gameId, 10);
                selectedGame = games.find((g) => g.id === idNum);
            }

            if (!selectedGame) {
                // Not Found Game
                embedGame("../404.html", "Game Not Found");
                favoriteButton.style.display = 'none'; // Hide favorite for 404
            } else {
                const page = selectedGame.page;
                const baseURL = getBaseURLForPage(page);
                let adjustedHref = selectedGame.href.replace(/^\.\//, "");
                adjustedHref = baseURL.endsWith("/") ? baseURL + adjustedHref : baseURL + "/" + adjustedHref;
                const embedPath = await getEmbedPath(adjustedHref, selectedGame.href, page);
                embedGame(embedPath, selectedGame.name);
                
                currentGameId = selectedGame.id; // Set global game ID
                // Note: The favorite status will be loaded in the separate 'userAuthenticated' block after Firebase loads.
            }
        });
        
        // --- END Game Loading Logic ---
        
        // This is a workaround to call the function after auth is complete
        document.addEventListener('userAuthenticated', (event) => {
            const userId = event.detail.uid;
            if (userId && currentGameId) {
                loadFavoriteStatus(userId, currentGameId);
            }
        });
    </script>

    <!-- Authentication Gate (Kept as a regular script block) -->
    <script>
        /**
         * Authentication Gate
         * This script protects the page by ensuring a user is logged in.
         * It reveals the page and dispatches an event for module scripts.
         */
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase === 'undefined') {
                document.body.style.visibility = 'visible';
                document.body.innerHTML = `<h1 style="color:white; text-align:center;">Error: Cannot connect to services (Firebase).</h1>`;
                return;
            }
            
            // Set up Firebase Auth and Firestore instances
            // Note: The __firebase_config and __initial_auth_token are provided globally by the Canvas environment.
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            db.settings({
                ignoreUndefinedProperties: true
            });
            firebase.firestore.setLogLevel('debug'); // Enable Firestore logging

            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            
            const handleAuth = async () => {
                try {
                    if (initialAuthToken) {
                        await auth.signInWithCustomToken(initialAuthToken);
                    } else {
                        await auth.signInAnonymously();
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    // Fallback to anonymous sign-in if custom token fails
                    await auth.signInAnonymously();
                }
            };
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is logged in. Reveal the page and notify modules.
                    document.body.style.visibility = 'visible';
                    document.dispatchEvent(new CustomEvent('userAuthenticated', { detail: { uid: user.uid } }));
                    
                } else {
                    // Start the authentication process if not already logged in
                    if (!auth.currentUser) {
                        handleAuth();
                    } else {
                        // If auth state changes to null unexpectedly, redirect to login
                        window.location.href = 'https://4simpleproblems.github.io/login.html';
                    }
                }
            });
        });
        
        // Prevent default behavior for directional keys for smoother iframe interaction
        document.addEventListener("keydown", function (event) {
            if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(event.key)) {
                // event.preventDefault(); // Commented out to allow iframe games to potentially handle these keys, 
                                          // but kept for reference if needed for the parent page.
            }
        });
    </script>
</body>
</html>
