<!DOCTYPE html>
<html lang="en">
<head>
    <title>4SP - Game Player</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <link rel="icon" type="image/x-icon" href="../img/favicon.ico" id="faviconLink" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'deep-black': '#070707',
                        'card-dark': '#111111',
                        'accent-indigo': '#4f46e5', // Unified accent color
                        'brand-border': '#252525',
                        'strongdog-orange': '#FFA500', 
                    },
                    fontFamily: {
                        sans: ['Geist', 'sans-serif'],
                    },
                    borderRadius: {
                        'md': '0.375rem',
                        'lg': '0.5rem',
                        'xl': '1rem',
                    },
                    aspectRatio: {
                        '3/2': '3 / 2',
                    },
                }
            },
        }
    </script>
    
    <style>
        /* Base styles */
        body {
            font-family: 'Geist', sans-serif;
            font-weight: 300;
            background-color: #070707; /* deep-black */
            color: #f3f3f3;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        h1, h2, h3, .font-bold, .font-semibold, strong {
            font-weight: 400 !important;
        }

        /* Game Container Aspect Ratio (16:9) */
        .game-container {
            width: 100%;
            padding-top: 56.25%; /* 9 / 16 * 100% for 16:9 aspect ratio */
            background-color: #000;
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
        }

        .game-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Styling for the overlay buttons (replicated sleek button style) */
        .overlay-btn {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            background-color: rgba(30, 30, 30, 0.5); /* Dark background */
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 20px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .overlay-btn:hover {
            transform: scale(1.05);
            background: rgba(0, 0, 0, 0.7);
            border-color: #4f46e5; /* accent-indigo */
        }

        /* Favorite Star coloring */
        #favoriteButton.favorited .fa-solid-star {
            color: #facc15; /* yellow-400 */
        }
    </style>
</head>

<body class="bg-deep-black text-white min-h-screen">
    <div class="navbar sticky top-0 z-50 bg-black/70 backdrop-blur-lg border-b border-brand-border h-16 flex items-center justify-between px-6 shadow-xl">
        <a href="https://forsimpleproblems.github.io/" class="text-white font-semibold text-lg" style="font-weight: 400;">4SP Games</a>
        <div></div> </div>

    <main class="mx-auto my-8 w-full max-w-screen-xl px-4">
        <div class="game-area" id="gameArea">
            <div class="game-container relative" id="gameContainer">
                <div id="gameTitle" class="absolute top-2 left-2 z-10 bg-black/60 backdrop-blur-sm rounded-md px-3 py-1 text-white truncate text-base font-semibold shadow-lg max-w-[50%]" style="font-weight: 400;">
                    </div>

                <div id="gameOverlayButtons" class="absolute top-2 right-2 z-10 flex items-center space-x-3">
                    <button id="favoriteButton" class="overlay-btn text-white transition duration-200 focus:outline-none" title="Favorite Game">
                        <i class="fa-solid fa-star fa-solid-star text-gray-500 transition-colors"></i>
                        <i class="fa-regular fa-star fa-regular-star text-white transition-colors hidden"></i>
                    </button>
                    <button id="fullscreenButton" class="overlay-btn text-white transition duration-200 focus:outline-none" title="Fullscreen">
                        <i class="fa-solid fa-expand"></i>
                    </button>
                </div>
                
                </div>
            
            <p id="fullscreenDisclaimer" class="text-center text-gray-400 mt-4 mb-8 text-sm">
                Use the fullscreen button for a better experience.
            </p>
        </div>
        
        </main>
    
    <script src="../firebase-config.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../ban-enforcer.js"></script>
    <script src="../url-changer.js"></script>
    <script src="../navigation.js"></script>
    <script src="../appscript.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script type="module">
        import games from "../cards-data.js";
        import {
            siteMapping
        } from "../site-mapping.js";

        // --- Firebase/Favorites Management ---
        const favoriteButton = document.getElementById("favoriteButton");
        let currentUserId = null;
        let currentGameId = null;

        function toggleFavoriteUI(isFavorited) {
            favoriteButton.classList.toggle('favorited', isFavorited);
            favoriteButton.title = isFavorited ? 'Remove from Favorites' : 'Add to Favorites';
            // Simple Font Awesome toggle based on the 'favorited' class
            favoriteButton.querySelector('.fa-solid-star').classList.toggle('hidden', !isFavorited);
            favoriteButton.querySelector('.fa-regular-star').classList.toggle('hidden', isFavorited);
        }
        
        async function loadFavoriteStatus(userId, gameId) {
            if (!userId || !gameId) return;
            currentUserId = userId;
            currentGameId = gameId;

            const db = firebase.firestore();
            try {
                const doc = await db.collection('users').doc(userId).collection('favorites').doc(String(gameId)).get();
                const isFavorited = doc.exists;
                toggleFavoriteUI(isFavorited);
            } catch (error) {
                console.error("Error loading favorite status:", error);
            }
        }

        async function toggleFavorite() {
            if (!currentUserId || !currentGameId) return;
            const db = firebase.firestore();
            const favoriteDocRef = db.collection('users').doc(currentUserId).collection('favorites').doc(String(currentGameId));

            try {
                const doc = await favoriteDocRef.get();
                if (doc.exists) {
                    // Remove favorite
                    await favoriteDocRef.delete();
                    toggleFavoriteUI(false);
                    console.log("Favorite removed.");
                } else {
                    // Add favorite (using a minimal document)
                    await favoriteDocRef.set({ added: firebase.firestore.FieldValue.serverTimestamp() });
                    toggleFavoriteUI(true);
                    console.log("Favorite added.");
                }
            } catch (error) {
                console.error("Error toggling favorite:", error);
            }
        }
        
        favoriteButton.addEventListener("click", toggleFavorite);
        // --- END Firebase/Favorites Management ---


        // --- Game Loading Logic (Copied from index(4).html) ---

        function getCurrentKeyHostOnly() {
            return window.location.host;
        }

        function getBaseURLForPage(page) {
            const currentHost = getCurrentKeyHostOnly();
            const currentPath = window.location.pathname;

            if (currentHost === "forsimpleproblems.github.io" && currentPath.toLowerCase().startsWith('/strongdog/')) {
                if (!page || page === 1) return "/STRONGDOG/";
                if (page === 2) return "/strongdog2/";
                if (page === 3) return "/strongdog3/";
                if (page === 4) return "/strongdog4/";
                if (page === 5) return "/strongdog5/";
                return "/STRONGDOG/";
            }
            const explicitMappings = {
                "jman1593.github.io": {
                    2: "../strongdog2/",
                },
                "v5-4simpleproblems.github.io": {
                    2: "../../strongdog2/",
                    3: "../../strongdog3/",
                    4: "../../strongdog4/",
                    5: "../../strongdog5/",
                }
            };
            if (explicitMappings[currentHost] && explicitMappings[currentHost][page]) {
                return explicitMappings[currentHost][page];
            }
            if (!page || page === 1) return "../";
            const arr = siteMapping[currentHost];
            if (!arr) {
                if (page === 2) return "../../strongdog2/";
                if (page === 3) return "../../strongdog3/";
                if (page === 4) return "../../strongdog4/";
                if (page === 5) return "../../strongdog5/";
                return "../";
            }
            const index = page - 2;
            if (arr[index]) return arr[index].replace(/^\.\/$/, "../");
            if (page === 2) return "../../strongdog2/";
            if (page === 3) return "../../strongdog3/";
            if (page === 4) return "../../strongdog4/";
            if (page === 5) return "../../strongdog5/";
            return "../../";
        }

        async function getEmbedPath(adjustedHref, originalHref, page) {
            let cleanHref = adjustedHref.replace(/index\.html$/, "").replace(/base\.html$/, "").replace(/\.html$/, "");
            if (!cleanHref.endsWith("/")) cleanHref += "/";
            const pathsToTry = [cleanHref + "game/index.html", cleanHref + "game/base.html", cleanHref + "gamereal/index.html", cleanHref + "gamereal/base.html", cleanHref + "index.html", cleanHref + "base.html", ];
            try {
                const response = await fetch(adjustedHref, {
                    method: "GET"
                });
                if (response.ok) {
                    const text = await response.text();
                    const match = text.match(/embedGame\((['"])(.*?)\1,\s*(['"])(.*?)\3\)/);
                    if (match) {
                        const [, , embedPath, , title] = match;
                        const resolvedPath = new URL(embedPath, adjustedHref).href;
                        if (await fileExists(resolvedPath)) return resolvedPath;
                    }
                }
            } catch (error) {
                console.warn("Failed to parse embed path from cards-data.js", error);
            }
            for (const path of pathsToTry) {
                if (await fileExists(path)) return path;
            }
            return adjustHrefPath(originalHref, page);
        }

        function adjustHrefPath(path, page) {
            path = path.replace(/^\.\//, "").replace(/^\//, "");
            const baseURL = getBaseURLForPage(page);
            let finalPath;
            if (baseURL === "../") {
                finalPath = "../" + path;
            } else {
                finalPath = baseURL.endsWith("/") ? baseURL + path : baseURL + "/" + path;
            }
            return finalPath;
        }

        async function fileExists(url) {
            try {
                const response = await fetch(url, {
                    method: "HEAD"
                });
                return response.ok;
            } catch {
                return false;
            }
        }

        function embedGame(gamePath, title) {
            const iframe = document.createElement("iframe");
            iframe.src = gamePath;
            iframe.allowFullscreen = true;
            iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-fullscreen');

            const gameContainer = document.getElementById('gameContainer');
            gameContainer.innerHTML = ''; 
            gameContainer.appendChild(iframe);

            const gameTitleElement = document.getElementById("gameTitle");
            gameTitleElement.textContent = title;
            // Also set as a tooltip for truncated title
            gameTitleElement.title = title;
        }
        
        // --- Fullscreen Logic ---
        const fullscreenButton = document.getElementById("fullscreenButton");
        fullscreenButton.addEventListener("click", () => {
            const gameIframe = document.querySelector('#gameContainer iframe');
            if (gameIframe) {
                if (gameIframe.requestFullscreen) {
                    gameIframe.requestFullscreen();
                } else if (gameIframe.webkitRequestFullscreen) {
                    gameIframe.webkitRequestFullscreen();
                } else if (gameIframe.msRequestFullscreen) {
                    gameIframe.msRequestFullscreen();
                }
            }
        });

        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", async function () {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get("id");
            let selectedGame = null;

            if (gameId) {
                const idNum = parseInt(gameId, 10);
                selectedGame = games.find((g) => g.id === idNum);
            }

            if (!selectedGame) {
                // Not Found Game
                embedGame("../404.html", "Game Not Found");
                favoriteButton.style.display = 'none'; // Hide favorite for 404
            } else {
                const page = selectedGame.page;
                const baseURL = getBaseURLForPage(page);
                let adjustedHref = selectedGame.href.replace(/^\.\//, "");
                adjustedHref = baseURL.endsWith("/") ? baseURL + adjustedHref : baseURL + "/" + adjustedHref;
                const embedPath = await getEmbedPath(adjustedHref, selectedGame.href, page);
                embedGame(embedPath, selectedGame.name);
                
                currentGameId = selectedGame.id; // Set global game ID
                // Note: The favorite status will be loaded in the separate 'userAuthenticated' block after Firebase loads.
            }
        });
        
        // --- END Game Loading Logic ---
        
        // This is a workaround to call the function after auth is complete
        document.addEventListener('userAuthenticated', (event) => {
            const userId = event.detail.uid;
            if (userId && currentGameId) {
                loadFavoriteStatus(userId, currentGameId);
            }
        });
    </script>

    <script>
        /**
         * Authentication Gate
         * This script protects the page by ensuring a user is logged in.
         * It reveals the page and dispatches an event for module scripts.
         */
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase === 'undefined') {
                document.body.style.visibility = 'visible';
                document.body.innerHTML = `<h1 style="color:white; text-align:center;">Error: Cannot connect to services (Firebase).</h1>`;
                return;
            }

            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    // User is logged in. Reveal the page and notify modules.
                    document.body.style.visibility = 'visible';
                    document.dispatchEvent(new CustomEvent('userAuthenticated', { detail: { uid: user.uid } }));
                    
                } else {
                    // User is logged out. Redirect them to the login page.
                    window.location.href = 'https://4simpleproblems.github.io/login.html';
                }
            });
        });
        
        // Prevent default behavior for directional keys for smoother iframe interaction
        document.addEventListener("keydown", function (event) {
            if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "].includes(event.key)) {
                event.preventDefault();
            }
        });
    </script>
</body>
</html>
