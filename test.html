<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [UPDATED] HTML Title -->
    <title>4SP - GAMES</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <link rel="icon" type="image/x-icon" href="img/favicon.ico" id="faviconLink" />

    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>

    <!-- Tailwind CSS Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'deep-black': '#070707',
                        'card-dark': '#111111',
                        'brand-purple': '#6366f1', // Indigo-500
                        'brand-border': 'rgba(255, 255, 255, 0.1)',
                    },
                    fontFamily: {
                        sans: ['Geist', 'sans-serif'],
                    },
                    boxShadow: {
                        '3xl': '0 35px 60px -15px rgba(0, 0, 0, 0.3)',
                    }
                },
            },
        }
    </script>

    <!-- Custom CSS Styles -->
    <style>
        body {
            background-color: #070707; /* deep-black */
            color: white;
            font-family: 'Geist', sans-serif;
            margin-top: 5rem; /* Space for the fixed nav/search bar */
        }
        
        .card-bg {
            background-color: #111111; /* card-dark */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Styling for the fixed bottom bar */
        #bottom-fixed-bar {
            background-color: rgba(0, 0, 0, 0.7); /* Translucent black */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        /* Custom scrollbar for game cards and search results */
        #gameCardsContainer::-webkit-scrollbar,
        .search-results::-webkit-scrollbar {
            width: 8px;
            background-color: #2a2a2a;
        }

        #gameCardsContainer::-webkit-scrollbar-thumb,
        .search-results::-webkit-scrollbar-thumb {
            background-color: #6366f1; /* brand-purple */
            border-radius: 4px;
        }
        
        /* Favorite Button Hover Icon Fix */
        .favorite-btn:not(.favorited) .fa-solid-star { display: none; }
        .favorite-btn.favorited .fa-regular-star { display: none; }
        .favorite-btn:hover .fa-solid-star { display: inline-block; color: #facc15; }
        .favorite-btn.favorited:hover .fa-regular-star { display: inline-block; color: #facc15; }
        
        /* Search Bar Results Styling */
        .search-results {
            max-height: 250px;
            overflow-y: auto;
        }
        .search-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .search-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* --- Marquee Animation (Updated for Hover/Ellipsis) --- */
        
        /* Keyframes for the infinite scroll */
        @keyframes marquee-scroll {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); } /* Scrolls one full copy + spacing */
        }

        .game-title-container {
            overflow: hidden;
            position: relative;
            /* [UPDATED] w-fit allows container to shrink when title is short */
            width: fit-content; 
            max-width: 75%;
        }
        
        /* Title text that fits should display normally (w-fit applied) */
        .title-text-visible {
            display: block;
            overflow: hidden;
            text-overflow: ellipsis; /* Ellipsis for non-scrolling state */
            white-space: nowrap;
        }

        /* When scrolling is active (on hover), take up max width and hide ellipsis */
        .game-title-container.scrolling {
            width: 100%;
            max-width: 100%; /* Temporarily use full space */
        }
        .game-title-container.scrolling .title-text-visible {
            display: none;
        }

        .marquee-content-wrapper {
            display: none; /* Hidden by default */
            white-space: nowrap; /* Required for scrolling */
        }
        .game-title-container.scrolling .marquee-content-wrapper {
            display: inline-block; /* Only visible when scrolling */
        }

        .marquee-content-wrapper.is-scrolling {
            animation: marquee-scroll linear infinite;
            /* duration is set by JS */
        }

        .marquee-content-wrapper > span {
            display: inline-block;
            padding-right: 3em; /* Spacing between copies */
        }
        /* --- End Marquee Styles --- */
        
        /* --- Play Icon Fix (Pre-load both icons, switch opacity) --- */
        .play-btn .fa-regular.fa-circle-play { opacity: 1; transition: opacity 0.1s ease-in-out; }
        .play-btn .fa-solid.fa-circle-play { opacity: 0; transition: opacity 0.1s ease-in-out; }
        .play-btn:hover .fa-regular.fa-circle-play { opacity: 0; }
        .play-btn:hover .fa-solid.fa-circle-play { opacity: 1; }
        /* --- End Play Icon Fix --- */
    </style>
</head>
<body class="min-h-screen">
    <div id="loadingOverlay" class="fixed inset-0 bg-deep-black z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-brand-purple border-opacity-75"></div>
        <span class="ml-4 text-white">Loading Games...</span>
    </div>

    <main class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-extrabold mb-4 text-center text-white/90">4SP Game Hub</h1>
        
        <!-- Category Navigation Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h2 id="categoryTitle" class="text-2xl font-semibold text-brand-purple mb-2 md:mb-0">All Games</h2>
            <div class="flex items-center space-x-2">
                <button id="prev-category" class="text-white hover:text-brand-purple transition-colors p-2 rounded-full disabled:text-gray-500" title="Previous Category">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button id="categoryCycleBtn" class="bg-card-dark text-white text-sm font-medium py-1.5 px-4 rounded-full hover:bg-white/10 transition-colors">
                    Next Category
                </button>
                <button id="next-category" class="text-white hover:text-brand-purple transition-colors p-2 rounded-full disabled:text-gray-500" title="Next Category">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Game Cards Container (Grid) -->
        <div id="gameCardsContainer" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            <!-- Game cards will be injected here -->
        </div>

        <div id="loadingMore" class="text-center mt-8 hidden">
            <div class="animate-spin rounded-full h-8 w-8 border-4 border-t-4 border-brand-purple border-opacity-75 mx-auto"></div>
            <p class="mt-2 text-gray-400">Loading more...</p>
        </div>
    </main>

    <!-- Fixed Bottom Bar for Search and Controls -->
    <div id="bottom-fixed-bar" class="fixed bottom-0 left-0 w-full p-3 shadow-3xl z-40">
        <div class="max-w-xl mx-auto relative flex items-center space-x-2">
            
            <!-- Search Bar Container -->
            <div class="flex-grow relative">
                <input 
                    type="text" 
                    id="searchInput"
                    placeholder="Search for games..." 
                    class="w-full py-2 pl-10 pr-12 text-sm bg-black/70 backdrop-blur-lg border border-brand-border rounded-xl focus:ring-2 focus:ring-brand-purple focus:border-brand-purple transition-all placeholder-gray-400 text-white shadow-xl"
                />
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                
                <!-- Filter Toggle Button (Panic Key inspired style) -->
                <button id="filterToggleBtn" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-brand-purple transition-colors" title="Filter Search">
                    <i class="fas fa-sliders-h"></i>
                </button>

                <!-- Search Results Dropdown -->
                <!-- [CHANGED] Updated background, blur, and border radius to match search bar -->
                <div class="search-results absolute bottom-full w-full mb-2 bg-black/70 backdrop-blur-lg rounded-xl border border-brand-border shadow-xl max-h-60 overflow-y-auto" id="searchResults" style="display: none;">
                    <!-- Search results dropdown will be injected here -->
                </div>
            </div>

            <!-- [NEW] Search Filter Dropdown (Same width as search bar) -->
            <div id="search-filter-dropdown" class="hidden absolute bottom-full w-full mb-2 bg-black/70 backdrop-blur-lg rounded-xl shadow-xl p-3 border border-brand-border">
                <p class="text-sm text-gray-300 mb-2">Filter search by category:</p>
                <div id="search-filter-options" class="flex flex-wrap gap-2">
                    <!-- Filter buttons will be injected here -->
                </div>
            </div>

            <!-- Global Controls (Zone Viewer, etc.) -->
            <div id="global-controls" class="flex items-center space-x-2">
                <button id="fullscreenBtnZone" class="bg-black/70 backdrop-blur-lg p-2 rounded-xl text-white/80 hover:text-white hover:bg-brand-purple/70 transition-colors shadow-xl" title="Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
                <button id="newTabBtnZone" class="bg-black/70 backdrop-blur-lg p-2 rounded-xl text-white/80 hover:text-white hover:bg-brand-purple/70 transition-colors shadow-xl" title="Open in New Tab">
                    <i class="fas fa-external-link-alt"></i>
                </button>
                <button id="closeBtnZone" class="bg-black/70 backdrop-blur-lg p-2 rounded-xl text-white/80 hover:text-white hover:bg-red-500/70 transition-colors shadow-xl" title="Close Game">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Game Viewer Zone Modal -->
    <div id="zoneViewer" class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center">
        <iframe id="zoneFrame" class="w-full h-full border-none rounded-none" allowfullscreen></iframe>
    </div>

    <script>
        // Use a global mock object for testing outside of the canvas environment
        // In the live canvas environment, this will be provided externally.
        const __app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const __firebase_config = typeof __firebase_config !== 'undefined' ? __firebase_config : '{"apiKey": "mock-key"}';
        const firebaseConfig = JSON.parse(__firebase_config);
        
        // --- Firebase Imports/Setup ---
        // Mocking firebase dependencies for this HTML file, as they are not used for the requested features
        const mockGamesData = [
            { id: 1, name: "Galactic Strategy", url: "https://example.com/game1", category: "Strategy", image: "https://placehold.co/400x250/333/fff?text=Galactic+Strategy" },
            { id: 2, name: "Pixel Racer 2000", url: "https://example.com/game2", category: "Racing", image: "https://placehold.co/400x250/333/fff?text=Pixel+Racer+2000" },
            { id: 3, name: "The Legend of Eldoria", url: "https://example.com/game3", category: "RPG", image: "https://placehold.co/400x250/333/fff?text=Legend+of+Eldoria" },
            { id: 4, name: "Z-Force Command", url: "https://example.com/game4", category: "Action", image: "https://placehold.co/400x250/333/fff?text=Z-Force+Command" },
            { id: 5, name: "Silent Hunter: Deep Sea", url: "https://example.com/game5", category: "Simulation", image: "https://placehold.co/400x250/333/fff?text=Silent+Hunter" },
            { id: 6, name: "Pancake Clicker Mania", url: "https://example.com/game6", category: "Casual", image: "https://placehold.co/400x250/333/fff?text=Pancake+Clicker" },
            { id: 7, name: "Cosmic Quest Alpha", url: "https://example.com/game7", category: "Adventure", image: "https://placehold.co/400x250/333/fff?text=Cosmic+Quest" },
            { id: 8, name: "Tower Defense Fortress", url: "https://example.com/game8", category: "Strategy", image: "https://placehold.co/400x250/333/fff?text=Tower+Defense" },
            { id: 9, name: "Neon Drift Legends", url: "https://example.com/game9", category: "Racing", image: "https://placehold.co/400x250/333/fff?text=Neon+Drift" },
            { id: 10, name: "A Very Long Game Title That Needs To Scroll", url: "https://example.com/game10", category: "Adventure", image: "https://placehold.co/400x250/333/fff?text=Scrolling+Title" },
            { id: 11, name: "Shorty", url: "https://example.com/game11", category: "Casual", image: "https://placehold.co/400x250/333/fff?text=Shorty" },
            { id: 12, name: "Epic Fantasy MMORPG: The Rebirth", url: "https://example.com/game12", category: "RPG", image: "https://placehold.co/400x250/333/fff?text=Epic+Fantasy" },
            { id: 13, name: "Drone Strike Simulator 2", url: "https://example.com/game13", category: "Simulation", image: "https://placehold.co/400x250/333/fff?text=Drone+Strike" },
            { id: 14, name: "Zombie Horde Survival Deluxe", url: "https://example.com/game14", category: "Action", image: "https://placehold.co/400x250/333/fff?text=Zombie+Survival" },
            { id: 15, name: "Chess Master Pro", url: "https://example.com/game15", category: "Strategy", image: "https://placehold.co/400x250/333/fff?text=Chess+Master" },
            { id: 16, name: "Kart Mania 7", url: "https://example.com/game16", category: "Racing", image: "https://placehold.co/400x250/333/fff?text=Kart+Mania" },
            // Add more mock data for lazy loading test (copy/paste up to 48 total)
            ...Array.from({ length: 32 }, (_, i) => ({ 
                id: i + 17, 
                name: `Filler Game ${i + 17}`, 
                url: `https://example.com/game${i + 17}`, 
                category: ["Casual", "Action", "Strategy"][i % 3], 
                image: `https://placehold.co/400x250/1c1c1c/fff?text=Game+${i + 17}` 
            }))
        ];
        
        let allGames = [];
        let gamesList = [];
        let categories = ["All Games"];
        let currentCategoryIndex = 0;
        let selectedFilterCategory = null; // New state for search filter
        let favorites = [];
        let searchFilterDropdownVisible = false;

        // --- New Globals for Lazy Loading ---
        const BATCH_SIZE = 24; // ~6 rows * 4 columns (for lg:grid-cols-4)
        let currentBatchIndex = 0;
        let isBatchLoading = false;
        
        // --- Marquee Timers ---
        let marqueeTimers = {};

        // --- Core Functions ---

        function loadGames() {
            // Mock: Fetching data and setting up initial state
            allGames = mockGamesData; 
            gamesList = [...allGames]; // Start with all games
            
            // Extract and sort categories
            const uniqueCategories = new Set(allGames.map(g => g.category).filter(c => c));
            categories = ["All Games", ...Array.from(uniqueCategories).sort()];
            
            // Set up search filter options
            renderSearchFilterOptions();
            
            // Start the loading process
            renderGameCards(gamesList); 
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function switchCategory(index) {
            currentCategoryIndex = index;
            const category = categories[currentCategoryIndex];
            document.getElementById('categoryTitle').textContent = category;

            gamesList = allGames.filter(game => 
                category === "All Games" || game.category === category
            );
            
            // Reset search and re-render
            document.getElementById('searchInput').value = '';
            handleSearch();
            
            // Scroll to top of cards
            document.getElementById('gameCardsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const container = document.getElementById('gameCardsContainer');
            const searchResults = document.getElementById('searchResults');
            
            let filteredGames = gamesList;

            // Apply category filter if one is selected in the search dropdown
            if (selectedFilterCategory && selectedFilterCategory !== 'All Games') {
                filteredGames = filteredGames.filter(game => game.category === selectedFilterCategory);
            }

            if (query.length > 0) {
                filteredGames = filteredGames.filter(game => 
                    game.name.toLowerCase().includes(query) || 
                    game.category.toLowerCase().includes(query)
                );
                
                // Show search results dropdown for better navigation
                const searchHtml = filteredGames.slice(0, 10).map(game => `
                    <div class="search-item" onclick="openGameZone(${game.id})" title="${game.name}">
                        <img src="${game.image}" alt="${game.name}" class="w-10 h-6 object-cover rounded mr-3">
                        <div>
                            <p class="text-white text-sm font-medium">${game.name}</p>
                            <p class="text-gray-400 text-xs">${game.category}</p>
                        </div>
                    </div>
                `).join('');
                searchResults.innerHTML = searchHtml.length > 0 ? searchHtml : '<div class="p-3 text-gray-400 text-sm">No games found.</div>';
                searchResults.style.display = 'block';

            } else {
                searchResults.style.display = 'none';
            }
            
            // Re-render the main grid with the search results
            renderGameCards(filteredGames);
        }

        function createGameCard(game) {
            const isFavorited = favorites.includes(game.id);

            const card = document.createElement('div');
            card.className = 'game-card relative card-bg rounded-xl shadow-xl overflow-hidden group transition-transform duration-300 hover:scale-[1.02] cursor-pointer';
            card.dataset.id = game.id;
            
            card.innerHTML = `
                <div class="relative w-full aspect-[4/2.5]">
                    <img 
                        data-src="${game.image}" 
                        alt="${game.name}" 
                        class="game-image w-full h-full object-cover transition-opacity duration-500 opacity-0" 
                        loading="lazy"
                        onload="this.style.opacity='1'"
                        onerror="this.src='https://placehold.co/400x250/111111/fff?text=Image+Error'; this.style.opacity='1';"
                    />

                    <!-- [UPDATED] Title container for Marquee/Ellipsis -->
                    <div class="game-title-container absolute top-2 right-2 bg-black/60 backdrop-blur-sm rounded-md px-2 py-1 text-sm font-semibold shadow-lg">
                        <!-- Ellipsis text (Visible when not scrolling) -->
                        <span class="title-text-visible text-white" title="${game.name}">${game.name}</span>
                        <!-- Marquee content (Visible when scrolling/hover) -->
                        <div class="marquee-content-wrapper">
                            <span class="text-white">${game.name}</span>
                        </div>
                    </div>
                    
                    <div class="absolute bottom-2 right-2 bg-black/60 backdrop-blur-sm rounded-full px-3 py-1.5 flex items-center space-x-3 shadow-lg">
                        <span class="text-xs text-gray-300">${game.category}</span>
                    </div>

                    <!-- Favorite Button -->
                    <button class="favorite-btn absolute top-2 left-2 p-2 rounded-full transition-colors ${isFavorited ? 'favorited text-yellow-400' : 'text-white/60 hover:text-yellow-400'}" 
                        onclick="toggleFavorite(event, ${game.id})">
                        <i class="fa-regular fa-star fa-regular-star"></i>
                        <i class="fa-solid fa-star fa-solid-star"></i>
                    </button>
                    
                    <!-- Play Button (Opacity is handled by card group:hover) -->
                    <button class="play-btn absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300"
                            onclick="openGameZone(${game.id})">
                        <div class="relative p-5 rounded-full bg-black/50 hover:bg-black/80 transition-all duration-150">
                            <!-- [FIX] Dual icons for no-flash hover -->
                            <i class="fa-regular fa-circle-play text-white text-3xl"></i>
                            <i class="fa-solid fa-circle-play text-white text-3xl absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
                        </div>
                    </button>
                </div>
            `;
            
            // Attach marquee setup after content is rendered
            setTimeout(() => setupMarquee(card), 0);
            
            return card;
        }

        // --- Marquee Logic ---
        function setupMarquee(gameCard) {
            const container = gameCard.querySelector('.game-title-container');
            const wrapper = container.querySelector('.marquee-content-wrapper');
            const ellipsisSpan = container.querySelector('.title-text-visible');

            if (!ellipsisSpan) return;
            
            // 1. Initial State: Ellipsis
            // Reset any previous scrolling setup
            wrapper.innerHTML = '';
            wrapper.classList.remove('is-scrolling');
            container.classList.remove('scrolling');
            container.style.width = 'fit-content';
            
            // 2. Check for Overflow (Temporarily remove ellipsis to measure full width)
            ellipsisSpan.classList.remove('title-text-visible'); 
            ellipsisSpan.style.whiteSpace = 'nowrap'; // Ensure full width calculation
            
            const needsScrolling = ellipsisSpan.scrollWidth > container.clientWidth;
            
            // Restore ellipsis style
            ellipsisSpan.classList.add('title-text-visible');
            ellipsisSpan.style.whiteSpace = ''; // Let CSS handle the overflow rule

            if (!needsScrolling) {
                // If it fits, no scrolling needed. Remove scroll setup.
                // The w-fit on container handles the short title width fix.
                return; 
            }
            
            // 3. Setup Hover for Scrolling Animation
            gameCard.addEventListener('mouseenter', () => startMarquee(gameCard, container, wrapper, ellipsisSpan));
            gameCard.addEventListener('mouseleave', () => stopMarquee(gameCard, container, wrapper, ellipsisSpan));
        }

        function startMarquee(gameCard, container, wrapper, ellipsisSpan) {
            // Clear stop timer if it exists
            clearTimeout(marqueeTimers[gameCard.dataset.id]);
            
            // Switch to scrolling mode
            container.classList.add('scrolling');
            container.style.width = '100%'; // Take up max width when scrolling
            
            // 1. Calculate and set animation duration
            const emSize = parseFloat(getComputedStyle(ellipsisSpan).fontSize || 16);
            
            // Set up the wrapper with two copies for seamless loop
            wrapper.innerHTML = `<span class="text-white">${ellipsisSpan.textContent}</span>`;
            const firstSpan = wrapper.querySelector('span');
            const scrollWidth = firstSpan.scrollWidth + (3 * emSize); // 3em padding
            const duration = scrollWidth / 40; // 40px per second scroll speed
            
            const secondSpan = firstSpan.cloneNode(true);
            wrapper.appendChild(secondSpan);

            // 2. Start animation
            wrapper.style.animationDuration = `${Math.max(5, duration)}s`;
            wrapper.classList.add('is-scrolling');
        }

        function stopMarquee(gameCard, container, wrapper, ellipsisSpan) {
            // Stop animation immediately
            wrapper.classList.remove('is-scrolling');
            wrapper.style.animationDuration = '';
            
            // Wait 100ms before snapping back to ellipsis view to allow transition to stop
            marqueeTimers[gameCard.dataset.id] = setTimeout(() => {
                // Reset the wrapper content and transform (snap back)
                wrapper.innerHTML = '';
                
                // Re-apply ellipsis/non-scrolling mode
                container.classList.remove('scrolling');
                container.style.width = 'fit-content'; // Go back to fit-content
            }, 100); 
        }

        // --- Batch Loading (Performance/Lazy Loading) ---

        function loadNextBatch() {
            if (isBatchLoading || currentBatchIndex >= gamesList.length) {
                document.getElementById('loadingMore').classList.add('hidden');
                return;
            }

            isBatchLoading = true;
            document.getElementById('loadingMore').classList.remove('hidden');

            const container = document.getElementById('gameCardsContainer');
            const gamesToLoad = gamesList.slice(currentBatchIndex, currentBatchIndex + BATCH_SIZE);
            
            gamesToLoad.forEach(game => {
                container.appendChild(createGameCard(game));
            });
            
            currentBatchIndex += BATCH_SIZE;
            isBatchLoading = false;
            
            // Check if there are more games to load
            if (currentBatchIndex >= gamesList.length) {
                document.getElementById('loadingMore').classList.add('hidden');
            }
        }

        let scrollTimer = null;
        function handleScroll() {
            // Throttling to check only when scrolling stops (or slows)
            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(() => {
                const container = document.getElementById('gameCardsContainer');
                
                // Load next batch if we are within 1.5 screen heights of the bottom of the container
                const scrollBottom = window.scrollY + window.innerHeight;
                const containerBottom = container.offsetTop + container.offsetHeight;
                
                if (scrollBottom > containerBottom - (window.innerHeight * 1.5)) {
                    loadNextBatch();
                }
            }, 150); // Check 150ms after scroll stops
        }

        function renderGameCards(games) {
            gamesList = games; // Update the list of games to be rendered/scrolled
            currentBatchIndex = 0;
            const container = document.getElementById('gameCardsContainer');
            container.innerHTML = '';
            
            loadNextBatch(); // Load the first batch
            
            // Add scroll listener for subsequent batches if not already there
            document.removeEventListener('scroll', handleScroll);
            if (gamesList.length > BATCH_SIZE) {
                document.addEventListener('scroll', handleScroll);
            }
        }

        function toggleFavorite(event, gameId) {
            event.stopPropagation();
            const index = favorites.indexOf(gameId);
            const btn = event.currentTarget;
            if (index > -1) {
                favorites.splice(index, 1);
                btn.classList.remove('favorited', 'text-yellow-400');
                btn.classList.add('text-white/60', 'hover:text-yellow-400');
            } else {
                favorites.push(gameId);
                btn.classList.add('favorited', 'text-yellow-400');
                btn.classList.remove('text-white/60', 'hover:text-yellow-400');
            }
            // In a real app, this would update Firestore.
        }
        
        // --- Search Filter Logic ---

        function renderSearchFilterOptions() {
            const filterContainer = document.getElementById('search-filter-options');
            filterContainer.innerHTML = '';

            const allBtn = createFilterButton('All Games', true);
            filterContainer.appendChild(allBtn);

            categories.filter(c => c !== 'All Games').forEach(category => {
                const btn = createFilterButton(category);
                filterContainer.appendChild(btn);
            });
        }
        
        function createFilterButton(categoryName, isDefault = false) {
            const button = document.createElement('button');
            button.textContent = categoryName;
            button.dataset.category = categoryName;
            button.className = `filter-btn text-xs font-medium py-1 px-2 rounded-full transition-colors ${
                (isDefault && !selectedFilterCategory) || selectedFilterCategory === categoryName
                ? 'bg-brand-purple text-white' : 'bg-white/10 text-gray-300 hover:bg-white/20'
            }`;
            
            button.addEventListener('click', () => {
                selectedFilterCategory = categoryName;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('bg-brand-purple', 'text-white');
                    btn.classList.add('bg-white/10', 'text-gray-300', 'hover:bg-white/20');
                });
                button.classList.add('bg-brand-purple', 'text-white');
                button.classList.remove('bg-white/10', 'text-gray-300', 'hover:bg-white/20');
                handleSearch(); // Re-run search with new filter
                toggleSearchFilterDropdown(); // Close dropdown after selection
            });
            return button;
        }

        function toggleSearchFilterDropdown() {
            const dropdown = document.getElementById('search-filter-dropdown');
            searchFilterDropdownVisible = !searchFilterDropdownVisible;
            dropdown.classList.toggle('hidden', !searchFilterDropdownVisible);
        }

        // --- Utility Functions (Zone Viewer) ---

        let lastOpenedGameUrl = '';

        function openGameZone(gameId) {
            const game = allGames.find(g => g.id === gameId);
            if (!game) return;

            lastOpenedGameUrl = game.url;
            const zoneViewer = document.getElementById('zoneViewer');
            const zoneFrame = document.getElementById('zoneFrame');

            zoneFrame.src = game.url;
            zoneViewer.classList.remove('hidden');
        }

        function closeZoneViewer() {
            const zoneViewer = document.getElementById('zoneViewer');
            const zoneFrame = document.getElementById('zoneFrame');
            zoneFrame.src = ''; // Clear iframe src to stop game
            zoneViewer.classList.add('hidden');
            lastOpenedGameUrl = '';
        }

        function openGameInNewTab() {
            if (lastOpenedGameUrl) {
                window.open(lastOpenedGameUrl, '_blank');
            }
        }

        // --- Initialization ---

        function initializeApp() {
            const searchInput = document.getElementById('searchInput');
            const categoryTitle = document.getElementById('categoryTitle');
            const prevCategoryBtn = document.getElementById('prev-category');
            const nextCategoryBtn = document.getElementById('next-category');
            const categoryCycleBtn = document.getElementById('categoryCycleBtn');
            const searchResults = document.getElementById('searchResults');
            const filterToggleBtn = document.getElementById('filterToggleBtn');

            loadGames();
            
            // --- Event Listeners ---
            searchInput.addEventListener("input", handleSearch);
            searchInput.addEventListener("focus", handleSearch);
            
            filterToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSearchFilterDropdown();
            });

            const cycle = (direction) => {
                 let newIndex = currentCategoryIndex + direction;
                 if (newIndex < 0) newIndex = categories.length - 1;
                 if (newIndex >= categories.length) newIndex = 0;
                 switchCategory(newIndex);
            };

            prevCategoryBtn.addEventListener('click', () => cycle(-1));
            nextCategoryBtn.addEventListener('click', () => cycle(1));
            categoryCycleBtn.addEventListener('click', () => cycle(1));

            // Close search results and filter dropdown when clicking outside
            document.addEventListener("click", ev => {
                const bottomBar = document.getElementById('bottom-fixed-bar');
                if (!bottomBar.contains(ev.target)) {
                    searchResults.style.display = "none";
                    document.getElementById('search-filter-dropdown').classList.add('hidden');
                    searchFilterDropdownVisible = false;
                }
            });

            document.getElementById('fullscreenBtnZone')?.addEventListener('click', () => {
                const zoneFrame = document.getElementById('zoneFrame');
                if (zoneFrame?.requestFullscreen) zoneFrame.requestFullscreen();
            });
            document.getElementById('newTabBtnZone')?.addEventListener('click', openGameInNewTab);
            document.getElementById('closeBtnZone')?.addEventListener('click', closeZoneViewer);
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
        window.addEventListener('resize', handleScroll); // Check for loading on resize too
    </script>
</body>
</html>
